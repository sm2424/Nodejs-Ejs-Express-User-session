<!-- views/profile.ejs -->
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>User Profile</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"
    integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
  <script src="https://code.jquery.com/jquery-3.7.1.js" integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4="
    crossorigin="anonymous"></script>
  <style>
    body {
      background-color: lightgoldenrodyellow;
      background-repeat: no-repeat;
      background-size: cover;
    }

    .custome-title {
      text-align: center;
      font-weight: bold;
    }

    input {
      border-radius: unset !important;
    }

    button {
      border-radius: unset !important;
      float: right;
      margin: 0.4rem;
    }

    .card {
      border-radius: unset !important;
      margin-top: 3rem;
      box-shadow: 0px 10px 10px 10px #a9a1a1;
    }

    .table td, .table th {
        border: none !important;
      }
  </style>
</head>

<body>
  <%- include('header', { pageTitle: 'Dashboard' , isLoggedIn: true, mobile_number: mobile_number }) -%>
    <div class="container">
      <div class="row">
        <div class="col-md-3">
        </div>
        <div class="col-md-6">
          <div class="card">
            <div class="card-header">
              <h4 class="" custome-title>User Profile </h4>
            </div>
            <div class="card-footer">
              <div id="response">
              </div>
              <div class="card-body">
                <div class="form-group">
                </div>
                
                <div class="form-group">
                     <table class="table">
                        <tbody>
                          <tr>
                            <td>Mobile Number:</td>
                            <td><%= mobile_number %></td>
                          </tr>
                          <tr>
                            <td>Name:</td>
                            <td><span id="name"></span></td>
                          </tr>
                          <tr>
                            <td>Phone Number ID:</td>
                            <td><span id="pni"></span></td>
                          </tr>
                          <tr>
                            <td>Permanent Access Token:</td>
                            <td><span id="pat"></span></td>
                          </tr>
                        </tbody>
                      </table>
                      
                </div>

                <div class="form-group">
                  
                  <button type="submit" class="btn btn-primary" id="editButton">Edit</button>
                  <button type="submit" class="btn btn-primary" id="saveButton" style="display: none;">Save</button>
                </div>
              </div>
            </div>
            <div id="updateMessage" class="alert alert-success" style="display: none;"></div>

          </div>
    </div>
       
        
    <script>
            $(document).ready(function(){
               function load_data()
                {
                    $.ajax({
                        url:"/profile",
                        method:"POST",
                        data:{action:'fetch'},
                        dataType : "JSON",
                        success:function(response)
                        {
                            var data = response.data; // Accessing data from the response
        
                            if (data.length > 0) 
                            {
                                const { username, phone_number_id, fb_pat } = data[0]; // Accessing the first record
                                $('#name').text(username); // Setting value for name input
                                $('#pni').text(phone_number_id); // Setting value for phone number ID input
                                $('#pat').text(fb_pat); // Setting value for permeant access token input
                            }
                        },
                        error: function(xhr, status, error) {
                            console.error(xhr.responseText); // Log any errors
                        }
                    });
                }
                load_data(); // Load data when the page loads

                // Edit button click event
                $('#editButton').click(function () {
                    $('.table td span').each(function () {
                    var value = $(this).text();
                    var input = $('<input type="text" class="form-control">');
                    input.val(value);
                    $(this).html(input);
                    });
                    $('#editButton').hide();
                    $('#saveButton').show();
                });



                // Save button click event
                $('#saveButton').click(function () {
                  var userData = {
                      username: $('#name input').val(), // Assuming the input field for name has an ID of "name"
                      phone_number_id: $('#pni input').val(), // Assuming the input field for phone number ID has an ID of "pni"
                      fb_pat: $('#pat input').val() // Assuming the input field for Facebook permanent access token has an ID of "pat"
                  };
              
                  // Send updated user data to the server for editing
                  $.ajax({
                      url: "/profile",
                      method: "POST",
                      data: { action: 'edit', userData: userData },
                      dataType: "JSON",
                      success: function (response) {
                          $('#updateMessage').html('Data updated successfully').removeClass('alert-danger').addClass('alert-success').show();
                          setTimeout(function () {
                              $('#updateMessage').hide();                                                           
                          }, 3000); // Hide the message after 3 seconds (3000 milliseconds)
                      },
                      error: function (xhr, status, error) {
                          $('#updateMessage').html('Error updating data').removeClass('alert-success').addClass('alert-danger').show();
                          console.error(xhr.responseText); // Log any errors
                      }
                  });
                  // Reverting back to span elements after saving
                  $('.table td').each(function () {
                  var input = $(this).find('input');
                  if (input.length > 0) {
                      var value = input.val();
                      $(this).find('span').text(value);
                  }
                });

                  $('#editButton').show();
                  $('#saveButton').hide();

              });
  });

</script>
        
</body>

</html>